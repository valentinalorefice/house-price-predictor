name: Flujo de Trabajo MLOps CI

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Permite la ejecución manual del pipeline

jobs:
  mlops_ci_job:
    runs-on: ubuntu-latest # El runner que usará esta VM

    steps:
      - name: Revisar el Código
        uses: actions/checkout@v4 # Paso 1: Descarga el código del repositorio
      
      - name: Configurar Entorno Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.5' # Paso 2: Usar la versión consistente
        
      - name: Instalar Dependencias del Proyecto
        run: | # Paso 3: Instala todas las dependencias
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --- Pasos de ML ---
      
      - name: Ejecutar Feature Engineering
        run: | # Paso 4: Prepara el dataset con features
          python src/features/engineer.py --input "./house_raw_data.csv" --output "./house_feature_data.csv" --preprocessor "./model/preprocessor.pkl"

      - name: Configurar MLflow (Docker)
        run: | # Paso 5: Solución para la dependencia de MLflow [cite: 1085-1095]
          # Descargar la imagen MLflow
          docker pull <imagen-mlflow> 
          # Iniciar el servidor MLflow en segundo plano (-d) y mapear puertos 5000 -> 5555
          docker run -d \
            -p 5555:5000 \
            --name mlflow-server \
            <imagen-mlflow> \
            mlflow server --host 0.0.0.0 --port 5000 

      - name: Ejecutar Model Training
        run: | # Paso 6: Entrena el modelo y lo registra en MLflow [cite: 1051-1055]
          python train_model.py --config_path="./configs/model_config.yaml" --input_dir="./" --output_dir="./model"

      - name: Limpiar MLflow
        run: | # Paso 7: Detener y eliminar el contenedor de MLflow [cite: 1117-1121]
          docker stop mlflow-server
          docker rm mlflow-server

      # --- Construcción y Publicación ---

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          [cite_start]password: ${{ secrets.DOCKER_PASSWORD }} # Usará el PAT (Token de Acceso Personal) [cite: 1144-1150]

      - name: Set up Docker Buildx
        [cite_start]uses: docker/setup-buildx-action@v3 # Configuración del constructor Docker [cite: 1151-1153]

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile # Asumiendo que el Dockerfile está en la raíz
          push: true
          tags: | # Etiquetado con latest y hash de commit [cite: 1161-1163]
            <TU_USUARIO>/fast-api:latest
            <TU_USUARIO>/fast-api:${{ github.sha }}